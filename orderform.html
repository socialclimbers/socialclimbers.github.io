<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout â€” Social Climbers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<!-- Toast notification (global) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="cartToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="cartToastBody">
        Added to cart!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark sc-navbar">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="assets/social_climbers_logo.png" class="logo-sm me-2" alt="Social Climbers"> Social Climbers
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="goods.html">Goods</a></li>
          <li class="nav-item"><a class="nav-link" href="services.html">Services</a></li>
          <li class="nav-item"><a class="nav-link active" href="orderform.html">Order</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="cart.html">Cart (<span id="cartCount">0</span>)</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <h2 class="mb-4">Checkout</h2>

    <!-- Cart review -->
    <div id="cartReview" class="mb-4"></div>

    <form id="orderForm" class="row g-3 needs-validation" novalidate>
      <!-- Personal details -->
      <div class="col-md-6">
        <label for="fullName" class="form-label">Full name</label>
        <input type="text" class="form-control" id="fullName" required>
        <div class="invalid-feedback">Please enter your name.</div>
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label">Email</label>
        <input type="email" id="email" class="form-control" required>
        <div class="invalid-feedback">Please enter a valid email.</div>
      </div>

      <!-- Delivery -->
      <div class="col-md-6">
        <label class="form-label">Delivery method</label>
        <select id="delivery" class="form-select">
          <option value="pickup">Pickup (free)</option>
          <option value="ship">Ship (+$12)</option>
        </select>
      </div>

      <div class="col-md-6">
        <label for="date" class="form-label">Preferred date</label>
        <input type="date" id="date" class="form-control">
      </div>

      <!-- Shipping address (hidden by default) -->
      <div id="shippingAddress" class="col-12" style="display:none;">
        <h5>Shipping Address</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="address1" class="form-label">Street Address</label>
            <input type="text" id="address1" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="address2" class="form-label">Apartment, Suite, etc. (optional)</label>
            <input type="text" id="address2" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="city" class="form-label">City</label>
            <input type="text" id="city" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="state" class="form-label">State/Province</label>
            <input type="text" id="state" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="postcode" class="form-label">Postal Code</label>
            <input type="text" id="postcode" class="form-control">
          </div>
        </div>
      </div>

      <!-- Payment -->
      <div class="col-12">
        <h5>Payment</h5>
      </div>
      <div class="col-md-6">
        <label for="cardName" class="form-label">Name on card</label>
        <input id="cardName" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label for="cardNumber" class="form-label">Card number</label>
        <input id="cardNumber" maxlength="19" class="form-control" placeholder="1234 1234 1234 1234" required>
      </div>
      <div class="col-md-4">
        <label for="expiry" class="form-label">Expiry</label>
        <input id="expiry" placeholder="MM/YY" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label for="cvc" class="form-label">CVC</label>
        <input id="cvc" maxlength="4" class="form-control" required>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Place Order</button>
      </div>
    </form>
  </main>

  <footer class="py-4 text-center">
    <div class="container">
      <p class="mb-1">&copy; <span class="year"></span> Social Climbers</p>
      <small class="text-muted">Website by <img src="assets/elevate_logo.png" alt="Elevate" class="logo-xs align-text-bottom"> Elevate Web Solutions</small>
    </div>
  </footer>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/main.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.year').forEach(el => el.textContent = new Date().getFullYear());
    });

    // Render cart review and update cartCount + sc_total
    function renderCartReview() {
      const cart = JSON.parse(localStorage.getItem('sc_cart') || '[]');
      const container = document.getElementById('cartReview');
      const cartCountEl = document.getElementById('cartCount');

      if (!container) return;

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">Your cart is empty.</div>
          <a href="goods.html" class="btn btn-primary">Go to Shop</a>
        `;
        cartCountEl && (cartCountEl.textContent = 0);
        localStorage.setItem('sc_total', '0');
        return;
      }

      let total = 0;
      let html = `<table class="table align-middle">
        <thead>
          <tr>
            <th>Item</th>
            <th style="width:120px;">Qty</th>
            <th>Price</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>`;

      cart.forEach(item => {
        const subtotal = (item.price || 0) * (item.qty || 1);
        total += subtotal;
        html += `
          <tr>
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td>$${(item.price || 0).toFixed(2)}</td>
            <td>$${subtotal.toFixed(2)}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;

      // Delivery cost
      const delivery = document.getElementById('delivery') ? document.getElementById('delivery').value : 'pickup';
      const deliveryCost = delivery === 'ship' ? 12 : 0;
      const totalWithDelivery = total + deliveryCost;

      html += `
        <div class="d-flex justify-content-between align-items-center">
          <h5>Total: $${totalWithDelivery.toFixed(2)}</h5>
          <div>
            <small class="text-muted">Delivery: $${deliveryCost.toFixed(2)}</small>
          </div>
        </div>
      `;

      container.innerHTML = html;
      cartCountEl && (cartCountEl.textContent = cart.reduce((s, i) => s + (i.qty || 0), 0));
      localStorage.setItem('sc_total', totalWithDelivery.toFixed(2));
    }

    // Show/hide shipping address fields when delivery changes
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'delivery') {
        const addr = document.getElementById('shippingAddress');
        addr.style.display = e.target.value === 'ship' ? 'block' : 'none';
        renderCartReview();
      }
    });

    // Form submit handler
    document.addEventListener("DOMContentLoaded", () => {
      renderCartReview();

      const form = document.querySelector("#orderForm");
      if (!form) return;

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          const firstInvalid = form.querySelector(':invalid');
          if (firstInvalid) firstInvalid.scrollIntoView({behavior: 'smooth', block: 'center'});
          return;
        }

        const order = {
          name: document.querySelector("#fullName").value,
          email: document.querySelector("#email").value,
          date: document.querySelector("#date").value,
          delivery: document.querySelector("#delivery").value,
          items: JSON.parse(localStorage.getItem("sc_cart") || "[]"),
          total: parseFloat(localStorage.getItem("sc_total") || 0).toFixed(2),
          address: (document.querySelector("#delivery").value === "ship") ? {
            line1: document.querySelector("#address1").value,
            line2: document.querySelector("#address2").value,
            city: document.querySelector("#city").value,
            state: document.querySelector("#state").value,
            postcode: document.querySelector("#postcode").value
          } : null
        };

        localStorage.setItem("sc_lastOrder", JSON.stringify(order));
        localStorage.removeItem("sc_cart");
        localStorage.removeItem("sc_total");
        window.location.href = "congratulations.html";
      });
    });
  </script>
</body>
</html>
